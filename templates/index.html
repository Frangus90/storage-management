<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .nav {
            display: flex;
            background: #34495e;
            overflow-x: auto;
        }

        .nav-btn {
            flex: 1;
            background: none;
            border: none;
            color: white;
            padding: 15px 10px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: #3498db;
        }

        .content {
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.ok {
            background: #d4edda;
            color: #155724;
        }

        .status.low {
            background: #f8d7da;
            color: #721c24;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn.success {
            background: #27ae60;
        }

        .btn.success:hover {
            background: #229954;
        }

        .btn.danger {
            background: #e74c3c;
        }

        .btn.danger:hover {
            background: #c0392b;
        }

        .btn.large {
            padding: 15px 25px;
            font-size: 16px;
            margin: 10px;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .qr-input {
            background: #f8f9fa;
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .pending-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #f39c12;
        }

        .pending-actions {
            margin-top: 10px;
        }

        .editable-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .editable-table th,
        .editable-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .editable-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .editable-table input {
            width: 100%;
            border: none;
            padding: 4px;
            background: transparent;
        }

        .editable-table input:focus {
            background: white;
            border: 1px solid #3498db;
            border-radius: 2px;
        }

        .file-upload {
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
        }

        .file-upload input[type="file"] {
            margin: 10px 0;
        }

        .data-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .data-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .qr-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .qr-code {
            width: 150px;
            height: 150px;
            margin: 10px auto;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .batch-generator {
            background: #e8f4fd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .manual-mode-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .manual-mode-form h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        #stock-adjustment-btn.active,
        #new-plate-btn.active {
            background: #27ae60;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 0;
            }

            .table {
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 8px 4px;
            }

            .nav {
                flex-wrap: wrap;
            }

            .nav-btn {
                flex: none;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Storage Management System</h1>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showPage('dashboard')">Dashboard</button>
            <button class="nav-btn" onclick="showPage('qr-scan')">QR Scan</button>
            <button class="nav-btn" onclick="showPage('pending')">Pending (<span id="pending-count">0</span>)</button>
            <button class="nav-btn" onclick="showPage('manual')">Manual Entry</button>
            <button class="nav-btn" onclick="showPage('admin')">Admin</button>
            <button class="nav-btn" onclick="showPage('qr-generator')">QR Generator</button>
            <button class="nav-btn" onclick="showPage('transactions')">Transactions</button>
        </div>

        <div class="content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-plates">0</div>
                        <div class="stat-label">Total Plate Types</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="low-stock">0</div>
                        <div class="stat-label">Low Stock Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pending-deliveries">0</div>
                        <div class="stat-label">Pending Deliveries</div>
                    </div>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Plate Size</th>
                            <th>In Stock</th>
                            <th>Threshold</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table">
                        <tr><td colspan="4" class="loading">Loading inventory...</td></tr>
                    </tbody>
                </table>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn large" onclick="showPage('manual')">+ Manual Entry</button>
                    <button class="btn large" onclick="showPage('pending')">View Pending Inbounds</button>
                </div>
            </div>

            <!-- QR Scan Page -->
            <div id="qr-scan" class="page">
                <h2>QR Code Scanner</h2>
                <div class="qr-input">
                    <p><strong>Scan pallet QR code or enter data manually:</strong></p>
                    <div class="form-group">
                        <label>QR Code Data:</label>
                        <input type="text" id="qr-url" placeholder="76x254|44|88|PLT123456">
                        <small>Format: PlateSize|BoxesOnPallet|PlatesPerBox|PalletID</small>
                    </div>
                    <button class="btn" onclick="processQRCode()">üì¶ Process Pallet QR Code</button>
                </div>
                <div id="qr-result"></div>
            </div>

            <!-- Pending Page -->
            <div id="pending" class="page">
                <h2>Pending Inbound Deliveries</h2>
                <div id="pending-list">
                    <p class="loading">Loading pending deliveries...</p>
                </div>
            </div>

            <!-- Manual Entry Page -->
            <div id="manual" class="page">
                <h2>Manual Entry</h2>
                
                <!-- Toggle buttons for mode selection -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn" id="stock-adjustment-btn" onclick="showManualMode('stock-adjustment')">üì¶ Stock Adjustment</button>
                    <button class="btn" id="new-plate-btn" onclick="showManualMode('new-plate')">‚ûï Add New Plate Size</button>
                </div>

                <!-- Stock Adjustment Form -->
                <div id="stock-adjustment-form" class="manual-mode-form">
                    <h3>Stock Adjustment</h3>
                    <form id="manual-form">
                        <div class="form-group">
                            <label for="manual-plate">Plate Size:</label>
                            <select id="manual-plate" required>
                                <option value="">Loading plates...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="manual-type">Adjustment Type:</label>
                            <select id="manual-type" required>
                                <option value="in">Add Stock (+)</option>
                                <option value="out">Remove Stock (-)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="manual-qty">Quantity:</label>
                            <input type="number" id="manual-qty" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="manual-notes">Notes:</label>
                            <textarea id="manual-notes" rows="3" placeholder="Reason for adjustment..."></textarea>
                        </div>
                        <button type="submit" class="btn">Apply Adjustment</button>
                    </form>
                </div>

                <!-- New Plate Form -->
                <div id="new-plate-form" class="manual-mode-form" style="display: none;">
                    <h3>Add New Plate Size</h3>
                    <form id="create-plate-form">
                        <div class="form-group">
                            <label for="new-plate-size">Plate Size:</label>
                            <input type="text" id="new-plate-size" placeholder="e.g., 100x200" pattern="^\d+x\d+$" title="Enter plate size as WidthxHeight (e.g., 100x200)" required>
                            <small>Format: WidthxHeight (numbers only, e.g., 100x200)</small>
                        </div>
                        <div class="form-group">
                            <label for="new-plate-quantity">Initial Stock Quantity:</label>
                            <input type="number" id="new-plate-quantity" min="0" value="0" required>
                        </div>
                        <div class="form-group">
                            <label for="new-plate-threshold">Low Stock Threshold:</label>
                            <input type="number" id="new-plate-threshold" min="0" value="50" required>
                        </div>
                        <button type="submit" class="btn success">Create New Plate Size</button>
                    </form>
                </div>
            </div>

            <!-- Admin Page -->
            <div id="admin" class="page">
                <h2>Admin Panel</h2>
                
                <div class="data-section">
                    <h3>üìù Edit Inventory & Thresholds</h3>
                    <p>Click on any stock or threshold value to edit it directly:</p>
                    <table class="editable-table">
                        <thead>
                            <tr>
                                <th>Plate Size</th>
                                <th>Current Stock</th>
                                <th>Threshold</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="editable-inventory">
                            <tr><td colspan="4" class="loading">Loading inventory...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="data-section">
                    <h3>üì§ Export Data</h3>
                    <p>Download your current inventory data:</p>
                    <button class="btn" onclick="exportInventory()">üìã Export Inventory (CSV)</button>
                    <button class="btn" onclick="exportTransactions()">üìä Export Transactions (CSV)</button>
                </div>

                <div class="data-section">
                    <h3>üóëÔ∏è Clear All Data</h3>
                    <p>Remove all data from the system. This action cannot be undone!</p>
                    <button class="btn danger" onclick="clearAllData()">‚ö†Ô∏è Clear All Data</button>
                </div>
            </div>

            <!-- QR Generator Page -->
            <div id="qr-generator" class="page">
                <h2>QR Code Generator</h2>
                
                <div class="batch-generator">
                    <h3>üéØ Pallet QR Code Generator</h3>
                    <form id="qr-form">
                        <div class="form-group">
                            <label for="qr-plate-size">Plate Size:</label>
                            <select id="qr-plate-size" required>
                                <option value="">Loading plates...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="qr-boxes">Number of Boxes on Pallet:</label>
                            <input type="number" id="qr-boxes" min="1" value="20" required>
                        </div>
                        <div class="form-group">
                            <label for="qr-plates-per-box">Plates per Box:</label>
                            <input type="number" id="qr-plates-per-box" min="1" value="25" required>
                        </div>
                        <div class="form-group">
                            <label>Total Plates on Pallet:</label>
                            <input type="text" id="total-plates-display" readonly style="background: #f8f9fa; font-weight: bold;">
                        </div>
                        <button type="submit" class="btn">üì± Generate Pallet QR Code</button>
                    </form>
                </div>

                <div id="generated-qr" class="qr-grid"></div>
            </div>

            <!-- Transactions Page -->
            <div id="transactions" class="page">
                <h2>Transaction Log</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Plate Size</th>
                            <th>Qty</th>
                            <th>Type</th>
                            <th>Source</th>
                            <th>Batch</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table">
                        <tr><td colspan="6" class="loading">Loading transactions...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let plates = [];
        let pendingDeliveries = [];
        let transactions = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadPlates();
            loadStats();
            loadPending();
            loadTransactions();
            
            // Initialize manual entry mode
            showManualMode('stock-adjustment');
            
            // Refresh stats every 30 seconds
            setInterval(() => {
                loadStats();
                loadPending();
            }, 30000);
        });

        // API functions
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API call failed');
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Load functions
        async function loadPlates() {
            try {
                plates = await apiCall('/api/plates');
                updateDashboard();
                updateManualForm();
                updateQRGeneratorForm();
                updateEditableInventory();
                document.getElementById('total-plates').textContent = plates.length;
            } catch (error) {
                console.error('Error loading plates:', error);
            }
        }

        async function loadStats() {
            try {
                const stats = await apiCall('/api/stats');
                document.getElementById('total-plates').textContent = stats.total_plates || 0;
                document.getElementById('low-stock').textContent = stats.low_stock || 0;
                document.getElementById('pending-deliveries').textContent = stats.pending_deliveries || 0;
                document.getElementById('pending-count').textContent = stats.pending_deliveries || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadPending() {
            try {
                pendingDeliveries = await apiCall('/api/pending');
                updatePendingList();
            } catch (error) {
                console.error('Error loading pending:', error);
            }
        }

        async function loadTransactions() {
            try {
                transactions = await apiCall('/api/transactions');
                updateTransactionsTable();
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        // UI Update functions
        function updateDashboard() {
            const tbody = document.querySelector('#inventory-table');
            
            if (plates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">No inventory data available</td></tr>';
                return;
            }
            
            tbody.innerHTML = plates.map(plate => `
                <tr>
                    <td>${plate.size}</td>
                    <td>${plate.quantity}</td>
                    <td>${plate.threshold}</td>
                    <td>
                        <span class="status ${plate.status}">
                            ${plate.status === 'ok' ? '‚úÖ OK' : '‚ö†Ô∏è Low'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updatePendingList() {
            const pendingList = document.getElementById('pending-list');
            
            if (pendingDeliveries.length === 0) {
                pendingList.innerHTML = '<p>No pending deliveries.</p>';
                return;
            }

            pendingList.innerHTML = pendingDeliveries.map(item => {
                let detailsHtml = `
                    <strong>Plate Size:</strong> ${item.plate_size}<br>
                    <strong>Total Quantity:</strong> ${item.quantity}<br>
                `;

                if (item.boxes && item.plates_per_box) {
                    detailsHtml += `
                        <strong>Boxes on Pallet:</strong> ${item.boxes}<br>
                        <strong>Plates per Box:</strong> ${item.plates_per_box}<br>
                    `;
                }

                detailsHtml += `
                    <strong>Pallet/Batch ID:</strong> ${item.batch_id}<br>
                    <strong>Received:</strong> ${new Date(item.timestamp).toLocaleString()}<br>
                `;

                return `
                    <div class="pending-item">
                        ${detailsHtml}
                        <div class="pending-actions">
                            <button class="btn success" onclick="approveDelivery('${item.batch_id}')">Approve</button>
                            <button class="btn danger" onclick="rejectDelivery('${item.batch_id}')">Reject</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateManualForm() {
            const plateSelect = document.getElementById('manual-plate');
            plateSelect.innerHTML = '<option value="">Select a plate size</option>' +
                plates.map(plate => `<option value="${plate.size}">${plate.size}</option>`).join('');
        }

        function updateQRGeneratorForm() {
            const plateSelect = document.getElementById('qr-plate-size');
            if (plateSelect) {
                plateSelect.innerHTML = '<option value="">Select a plate size</option>' +
                    plates.map(plate => `<option value="${plate.size}">${plate.size}</option>`).join('');
            }
            
            // Update total calculation
            const boxesInput = document.getElementById('qr-boxes');
            const platesPerBoxInput = document.getElementById('qr-plates-per-box');
            const totalDisplay = document.getElementById('total-plates-display');

            function updateTotalCalculation() {
                const boxes = parseInt(boxesInput.value) || 0;
                const platesPerBox = parseInt(platesPerBoxInput.value) || 0;
                const total = boxes * platesPerBox;
                totalDisplay.value = total > 0 ? `${total} plates` : '';
            }

            if (boxesInput && platesPerBoxInput) {
                boxesInput.addEventListener('input', updateTotalCalculation);
                platesPerBoxInput.addEventListener('input', updateTotalCalculation);
                updateTotalCalculation();
            }
        }

        function updateEditableInventory() {
            const tbody = document.getElementById('editable-inventory');
            
            if (plates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">No inventory data available</td></tr>';
                return;
            }

            tbody.innerHTML = plates.map(plate => `
                <tr>
                    <td>${plate.size}</td>
                    <td>
                        <input type="number" value="${plate.quantity}" 
                               onchange="updatePlateData(${plate.id}, 'quantity', this.value)" 
                               min="0">
                    </td>
                    <td>
                        <input type="number" value="${plate.threshold}" 
                               onchange="updatePlateData(${plate.id}, 'threshold', this.value)" 
                               min="0">
                    </td>
                    <td>
                        <span class="status ${plate.status}">
                            ${plate.status === 'ok' ? '‚úÖ OK' : '‚ö†Ô∏è Low'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateTransactionsTable() {
            const tbody = document.getElementById('transactions-table');
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No transactions yet.</td></tr>';
                return;
            }

            tbody.innerHTML = transactions.map(tx => `
                <tr>
                    <td>${new Date(tx.date).toLocaleString()}</td>
                    <td>${tx.plate_size}</td>
                    <td>${tx.type === 'in' ? '+' : '-'}${tx.quantity}</td>
                    <td>${tx.type.toUpperCase()}</td>
                    <td>${tx.source.toUpperCase()}</td>
                    <td>${tx.batch_id || '-'}</td>
                </tr>
            `).join('');
        }

        // Page navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');

            // Refresh data when switching pages
            if (pageId === 'pending') {
                loadPending();
            } else if (pageId === 'transactions') {
                loadTransactions();
            } else if (pageId === 'manual') {
                showManualMode('stock-adjustment');
            }
        }

        // Action functions
        async function processQRCode() {
            const qrData = document.getElementById('qr-url').value.trim();
            const resultDiv = document.getElementById('qr-result');

            if (!qrData) {
                resultDiv.innerHTML = '<div class="alert error">Please enter QR code data</div>';
                return;
            }

            try {
                const result = await apiCall('/api/inbound', {
                    method: 'POST',
                    body: JSON.stringify({ qr_data: qrData })
                });

                resultDiv.innerHTML = `
                    <div class="alert success">
                        <strong>‚úÖ Pallet QR Code Processed Successfully!</strong><br>
                        <strong>Pallet ID:</strong> ${result.pallet.batch_id}<br>
                        <strong>Plate Size:</strong> ${result.pallet.plate_size}<br>
                        <strong>Total Quantity:</strong> ${result.pallet.quantity}<br>
                        <strong>Status:</strong> Pending Approval
                    </div>
                `;

                document.getElementById('qr-url').value = '';
                loadStats();
                loadPending();

            } catch (error) {
                resultDiv.innerHTML = `<div class="alert error">Error: ${error.message}</div>`;
            }
        }

        async function approveDelivery(batchId) {
            try {
                await apiCall(`/api/approve/${batchId}`, { method: 'POST' });
                alert('Delivery approved successfully!');
                loadPlates();
                loadStats();
                loadPending();
                loadTransactions();
            } catch (error) {
                alert('Error approving delivery: ' + error.message);
            }
        }

        async function rejectDelivery(batchId) {
            try {
                await apiCall(`/api/reject/${batchId}`, { method: 'POST' });
                alert('Delivery rejected.');
                loadStats();
                loadPending();
            } catch (error) {
                alert('Error rejecting delivery: ' + error.message);
            }
        }

        async function updatePlateData(plateId, field, value) {
            const plate = plates.find(p => p.id === plateId);
            if (!plate) return;

            try {
                const updatedPlate = await apiCall('/api/plates', {
                    method: 'POST',
                    body: JSON.stringify({
                        id: plateId,
                        quantity: field === 'quantity' ? parseInt(value) : plate.quantity,
                        threshold: field === 'threshold' ? parseInt(value) : plate.threshold
                    })
                });

                // Update local state
                const index = plates.findIndex(p => p.id === plateId);
                if (index !== -1) {
                    plates[index] = updatedPlate;
                }

                loadStats();
                updateDashboard();
                updateEditableInventory();

            } catch (error) {
                alert('Error updating plate: ' + error.message);
                loadPlates(); // Reload to restore original values
            }
        }

        async function clearAllData() {
            if (!confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                return;
            }

            if (!confirm('This will delete ALL inventory, transactions, and pending deliveries. Are you absolutely sure?')) {
                return;
            }

            try {
                const result = await apiCall('/api/clear-all', { method: 'POST' });
                alert(result.message || 'All data has been cleared successfully');
                
                // Reload all data
                loadPlates();
                loadStats();
                loadPending();
                loadTransactions();
                
            } catch (error) {
                alert('Error clearing data: ' + error.message);
            }
        }

        // Export functions
        function exportInventory() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "plate_size,quantity,threshold,status\n" +
                plates.map(plate => `${plate.size},${plate.quantity},${plate.threshold},${plate.status}`).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `inventory_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportTransactions() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "date,plate_size,quantity,type,source,batch_id,notes\n" +
                transactions.map(tx => 
                    `${tx.date},${tx.plate_size},${tx.quantity},${tx.type},${tx.source},${tx.batch_id || ''},${tx.notes || ''}`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `transactions_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Manual entry mode management
        function showManualMode(mode) {
            const stockForm = document.getElementById('stock-adjustment-form');
            const newPlateForm = document.getElementById('new-plate-form');
            const stockBtn = document.getElementById('stock-adjustment-btn');
            const newPlateBtn = document.getElementById('new-plate-btn');

            if (mode === 'stock-adjustment') {
                stockForm.style.display = 'block';
                newPlateForm.style.display = 'none';
                stockBtn.classList.add('active');
                newPlateBtn.classList.remove('active');
            } else {
                stockForm.style.display = 'none';
                newPlateForm.style.display = 'block';
                stockBtn.classList.remove('active');
                newPlateBtn.classList.add('active');
            }
        }

        // Form handlers
        document.getElementById('manual-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const plateSize = document.getElementById('manual-plate').value;
            const type = document.getElementById('manual-type').value;
            const quantity = parseInt(document.getElementById('manual-qty').value);
            const notes = document.getElementById('manual-notes').value;

            try {
                await apiCall('/api/manual', {
                    method: 'POST',
                    body: JSON.stringify({
                        plate_size: plateSize,
                        quantity: quantity,
                        type: type,
                        notes: notes
                    })
                });

                alert(`Stock ${type === 'in' ? 'added' : 'removed'} successfully!`);
                document.getElementById('manual-form').reset();
                
                loadPlates();
                loadStats();
                loadTransactions();

            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('create-plate-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const plateSize = document.getElementById('new-plate-size').value.trim();
            const quantity = parseInt(document.getElementById('new-plate-quantity').value);
            const threshold = parseInt(document.getElementById('new-plate-threshold').value);

            try {
                const result = await apiCall('/api/plates/create', {
                    method: 'POST',
                    body: JSON.stringify({
                        plate_size: plateSize,
                        quantity: quantity,
                        threshold: threshold
                    })
                });

                alert(result.message || 'Plate created successfully!');
                document.getElementById('create-plate-form').reset();
                
                // Reload all data
                loadPlates();
                loadStats();
                if (result.plate.quantity > 0) {
                    loadTransactions();
                }

                // Switch back to stock adjustment mode
                showManualMode('stock-adjustment');

            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        document.getElementById('qr-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const plateSize = document.getElementById('qr-plate-size').value;
            const boxes = parseInt(document.getElementById('qr-boxes').value);
            const platesPerBox = parseInt(document.getElementById('qr-plates-per-box').value);
            
            try {
                const palletIdResponse = await apiCall('/api/generate-pallet-id');
                const palletId = palletIdResponse.pallet_id;
                
                const qrData = `${plateSize}|${boxes}|${platesPerBox}|${palletId}`;
                
                const generatedDiv = document.getElementById('generated-qr');
                generatedDiv.innerHTML = `
                    <h3>üì± Generated Pallet QR Code</h3>
                    <div class="qr-card">
                        <h4>üè∑Ô∏è Pallet: ${palletId}</h4>
                        <p><strong>Plate Size:</strong> ${plateSize}</p>
                        <p><strong>Boxes:</strong> ${boxes}</p>
                        <p><strong>Plates/Box:</strong> ${platesPerBox}</p>
                        <p><strong>Total Plates:</strong> ${boxes * platesPerBox}</p>
                        <div class="qr-code">
                            <div style="padding: 20px;">
                                <strong>QR DATA:</strong><br>
                                <small style="word-break: break-all; font-family: monospace;">${qrData}</small>
                            </div>
                        </div>
                        <button class="btn" onclick="copyToClipboard('${qrData}')">üìã Copy QR Data</button>
                    </div>
                `;
                
            } catch (error) {
                alert('Error generating pallet ID: ' + error.message);
            }
        });

        // Utility functions
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('QR data copied to clipboard!');
            }).catch(err => {
                alert('Failed to copy: ' + err);
            });
        }
    </script>
</body>
</html>
