<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        // Admin Page Functions
        function updateAdminPage() {
            updateEditableInventory();
            updateQRGeneratorPage();
        }

        function updateEditableInventory() {
            const editableInventory = document.getElementById('editable-inventory');
            editableInventory.innerHTML = '';

            plates.forEach(plate => {
                const row = document.createElement('tr');
                const isLowStock = plate.quantity <= plate.threshold;

                row.innerHTML = `
                    <td>${plate.size}</td>
                    <td>
                        <input type="number" value="${plate.quantity}" 
                               onchange="updatePlateData(${plate.id}, 'quantity', this.value)" 
                               min="0">
                    </td>
                    <td>
                        <input type="number" value="${plate.threshold}" 
                               onchange="updatePlateData(${plate.id}, 'threshold', this.value)" 
                               min="0">
                    </td>
                    <td>
                        <span class="status ${isLowStock ? 'low' : 'ok'}">
                            ${isLowStock ? '‚ö†Ô∏è Low' : '‚úÖ OK'}
                        </span>
                    </td>
                `;
                editableInventory.appendChild(row);
            });
        }

        function updatePlateData(plateId, field, value) {
            const plate = plates.find(p => p.id === plateId);
            if (plate) {
                plate[field] = parseInt(value);
                updateDashboard();
                updateEditableInventory();
            }
        }

        function saveInventoryChanges() {
            alert('All inventory changes have been saved!');
            updateDashboard();
        }

        function exportInventory() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "plate_size,quantity,threshold\n" +
                plates.map(plate => `${plate.size},${plate.quantity},${plate.threshold}`).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `inventory_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportTransactions() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "date,plate_size,quantity,type,source,batch_id\n" +
                transactions.map(tx => `${tx.date},${tx.plate_size},${tx.quantity},${tx.type},${tx.source},${tx.batch_id || ''}`).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `transactions_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',');
                    
                    // Validate headers
                    if (!headers.includes('plate_size') || !headers.includes('quantity') || !headers.includes('threshold')) {
                        throw new Error('CSV must have columns: plate_size, quantity, threshold');
                    }

                    // Process data
                    let updatedCount = 0;
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        if (values.length >= 3) {
                            const plateSize = values[0].trim();
                            const quantity = parseInt(values[1]);
                            const threshold = parseInt(values[2]);
                            
                            const plate = plates.find(p => p.size === plateSize);
                            if (plate) {
                                plate.quantity = quantity;
                                plate.threshold = threshold;
                                updatedCount++;
                            }
                        }
                    }

                    alert(`Successfully updated ${updatedCount} plate entries!`);
                    updateUI();
                    updateAdminPage();
                    
                } catch (error) {
                    alert(`Error importing CSV: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        function resetSystem() {
            if (confirm('Are you sure you want to reset ALL data? This cannot be undone.')) {
                if (confirm('This will delete all inventory, transactions, and pending deliveries. Continue?')) {
                    initializeData();
                    inboundQueue = [];
                    transactions = [];
                    alert('System has been reset to initial state.');
                    updateUI();
                }
            }
        }

        // QR Generator Functions
        function updateQRGeneratorPage() {
            const plateSelect = document.getElementById('qr-plate-size');
            plateSelect.innerHTML = plates.map(plate => 
                `<option value="${plate.size}">${plate.size}</option>`
            ).join('');
        }

        function generateBatchId() {
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `BATCH${timestamp}${random}`;
        }

        function generateQRCodeSVG(text) {
            // Simple QR code placeholder - in real implementation, use a QR library
            return `
                <svg width="150" height="150" viewBox="0 0 150 150">
                    <rect width="150" height="150" fill="white" stroke="#000" stroke-width="1"/>
                    <text x="75" y="75" text-anchor="middle" dominant-baseline="middle" font-size="8" fill="#000">
                        QR CODE
                    </text>
                    <text x="75" y="90" text-anchor="middle" dominant-baseline="middle" font-size="6" fill="#666">
                        ${text.length > 20 ? text.substring(0, 20) + '...' : text}
                    </text>
                </svg>
            `;
        }

        function generateSingleQR(plateSize, quantity, batchId, baseUrl) {
            const url = `${baseUrl}?plate=${plateSize}&qty=${quantity}&batch=${batchId}`;
            
            return `
                <div class="qr-card">
                    <h4>Plate: ${plateSize}</h4>
                    <p>Quantity: ${quantity}</p>
                    <p>Batch: ${batchId}</p>
                    <div class="qr-code">
                        ${generateQRCodeSVG(url)}
                    </div>
                    <small style="word-break: break-all;">${url}</small>
                    <br><br>
                    <button class="btn" onclick="downloadQR('${batchId}', '${url}')">üì• Download</button>
                    <button class="btn" onclick="printQR('${batchId}')">üñ®Ô∏è Print</button>
                </div>
            `;
        }

        function generateBatchQRs() {
            const commonSizes = ['50x100', '75x150', '100x200', '50x150', '75x100', '100x150', '50x200', '75x200', '100x100', '125x150'];
            const baseUrl = document.getElementById('base-url').value;
            const generatedDiv = document.getElementById('generated-qr');
            
            let html = '<h3>üì¶ Batch Generated QR Codes</h3>';
            
            commonSizes.forEach(size => {
                const batchId = generateBatchId();
                const quantity = 100; // Default quantity
                html += generateSingleQR(size, quantity, batchId, baseUrl);
            });
            
            generatedDiv.innerHTML = html;
        }

        function generateAllQRs() {
            const baseUrl = document.getElementById('base-url').value;
            const generatedDiv = document.getElementById('generated-qr');
            
            let html = '<h3>üéØ All Plate Sizes QR Codes</h3>';
            
            plates.forEach(plate => {
                const batchId = generateBatchId();
                const quantity = 100; // Default quantity
                html += generateSingleQR(plate.size, quantity, batchId, baseUrl);
            });
            
            generatedDiv.innerHTML = html;
        }

        function downloadQR(batchId, url) {
            // Create a simple text file with the QR data
            const content = `QR Code Data for Batch: ${batchId}\nURL: ${url}\n\nUse this URL to generate a real QR code with your preferred QR generator.`;
            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `qr_${batchId}.txt`;
            link.click();
        }

        function printQR(batchId) {
            alert(`Print function for ${batchId} - In a real implementation, this would send the QR code to your printer.`);
        }

        // QR Form submission
        document.getElementById('qr-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const plateSize = document.getElementById('qr-plate-size').value;
            const boxes = parseInt(document.getElementById('qr-boxes').value);
            const platesPerBox = parseInt(document.getElementById('qr-plates-per-box').value);
            const palletId = generatePalletId();
            
            // Update the pallet ID field to show what was generated
            document.getElementById('pallet-id').value = palletId;
            
            const generatedDiv = document.getElementById('generated-qr');
            generatedDiv.innerHTML = '<h3>üì± Generated Pallet QR Code</h3>' + 
                generatePalletQR(plateSize, boxes, platesPerBox, palletId);
        });

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .nav {
            display: flex;
            background: #34495e;
            overflow-x: auto;
        }

        .nav-btn {
            flex: 1;
            background: none;
            border: none;
            color: white;
            padding: 15px 10px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: #3498db;
        }

        .content {
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status.ok {
            background: #d4edda;
            color: #155724;
        }

        .status.low {
            background: #f8d7da;
            color: #721c24;
        }

        .status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn.success {
            background: #27ae60;
        }

        .btn.success:hover {
            background: #229954;
        }

        .btn.danger {
            background: #e74c3c;
        }

        .btn.danger:hover {
            background: #c0392b;
        }

        .btn.large {
            padding: 15px 25px;
            font-size: 16px;
            margin: 10px;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .qr-input {
            background: #f8f9fa;
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .pending-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #f39c12;
        }

        .pending-actions {
            margin-top: 10px;
        }

        .editable-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .editable-table th,
        .editable-table td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .editable-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .editable-table input {
            width: 100%;
            border: none;
            padding: 4px;
            background: transparent;
        }

        .editable-table input:focus {
            background: white;
            border: 1px solid #3498db;
            border-radius: 2px;
        }

        .file-upload {
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9fa;
        }

        .file-upload input[type="file"] {
            margin: 10px 0;
        }

        .data-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .data-section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .qr-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .qr-code {
            width: 150px;
            height: 150px;
            margin: 10px auto;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .batch-generator {
            background: #e8f4fd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 0;
            }

            .table {
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 8px 4px;
            }

            .nav {
                flex-wrap: wrap;
            }

            .nav-btn {
                flex: none;
                min-width: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Storage Management System</h1>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showPage('dashboard')">Dashboard</button>
            <button class="nav-btn" onclick="showPage('qr-scan')">QR Scan</button>
            <button class="nav-btn" onclick="showPage('pending')">Pending (<span id="pending-count">0</span>)</button>
            <button class="nav-btn" onclick="showPage('manual')">Manual Entry</button>
            <button class="nav-btn" onclick="showPage('admin')">Admin</button>
            <button class="nav-btn" onclick="showPage('qr-generator')">QR Generator</button>
            <button class="nav-btn" onclick="showPage('transactions')">Transactions</button>
        </div>

        <div class="content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-plates">39</div>
                        <div class="stat-label">Total Plate Types</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="low-stock">0</div>
                        <div class="stat-label">Low Stock Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pending-deliveries">0</div>
                        <div class="stat-label">Pending Deliveries</div>
                    </div>
                </div>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Plate Size</th>
                            <th>In Stock</th>
                            <th>Threshold</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-table">
                    </tbody>
                </table>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn large" onclick="showPage('manual')">+ Manual Entry</button>
                    <button class="btn large" onclick="showPage('pending')">View Pending Inbounds</button>
                </div>
            </div>

            <!-- QR Scan Page -->
            <div id="qr-scan" class="page">
                <h2>QR Code Scanner</h2>
                <div class="qr-input">
                    <p><strong>Scan pallet QR code or enter data manually:</strong></p>
                    <div class="form-group">
                        <label>QR Code Data:</label>
                        <input type="text" id="qr-url" placeholder="76x254|44|88|PLT123456 or legacy URL format">
                        <small>Format: PlateSize|BoxesOnPallet|PlatesPerBox|PalletID</small>
                    </div>
                    <button class="btn" onclick="processQRCode()">üì¶ Process Pallet QR Code</button>
                </div>
                <div id="qr-result"></div>
            </div>

            <!-- Pending Page -->
            <div id="pending" class="page">
                <h2>Pending Inbound Deliveries</h2>
                <div id="pending-list"></div>
            </div>

            <!-- Manual Entry Page -->
            <div id="manual" class="page">
                <h2>Manual Stock Adjustment</h2>
                <form id="manual-form">
                    <div class="form-group">
                        <label for="manual-plate">Plate Size:</label>
                        <select id="manual-plate" required></select>
                    </div>
                    <div class="form-group">
                        <label for="manual-type">Adjustment Type:</label>
                        <select id="manual-type" required>
                            <option value="in">Add Stock (+)</option>
                            <option value="out">Remove Stock (-)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="manual-qty">Quantity:</label>
                        <input type="number" id="manual-qty" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="manual-notes">Notes:</label>
                        <textarea id="manual-notes" rows="3" placeholder="Reason for adjustment..."></textarea>
                    </div>
                    <button type="submit" class="btn">Apply Adjustment</button>
                </form>
            </div>

            <!-- Admin Page -->
            <div id="admin" class="page">
                <h2>Admin Panel</h2>
                
                <div class="data-section">
                    <h3>üìù Edit Inventory & Thresholds</h3>
                    <p>Click on any stock or threshold value to edit it directly:</p>
                    <table class="editable-table">
                        <thead>
                            <tr>
                                <th>Plate Size</th>
                                <th>Current Stock</th>
                                <th>Threshold</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="editable-inventory">
                        </tbody>
                    </table>
                    <button class="btn" onclick="saveInventoryChanges()">üíæ Save All Changes</button>
                </div>

                <div class="data-section">
                    <h3>üì§ Export Data</h3>
                    <p>Download your current inventory data:</p>
                    <button class="btn" onclick="exportInventory()">üìã Export Inventory (CSV)</button>
                    <button class="btn" onclick="exportTransactions()">üìä Export Transactions (CSV)</button>
                </div>

                <div class="data-section">
                    <h3>üì• Import Data</h3>
                    <p>Upload a CSV file to update inventory in bulk:</p>
                    <div class="file-upload">
                        <input type="file" id="import-file" accept=".csv" />
                        <button class="btn" onclick="importData()">üîÑ Import CSV</button>
                    </div>
                    <small>CSV format: plate_size,quantity,threshold</small>
                </div>

                <div class="data-section">
                    <h3>üóëÔ∏è Reset System</h3>
                    <p>Reset all data to initial state:</p>
                    <button class="btn danger" onclick="resetSystem()">‚ö†Ô∏è Reset All Data</button>
                </div>
            </div>

            <!-- QR Generator Page -->
            <div id="qr-generator" class="page">
                <h2>QR Code Generator</h2>
                
                <div class="batch-generator">
                    <h3>üéØ Pallet QR Code Generator</h3>
                    <form id="qr-form">
                        <div class="form-group">
                            <label for="qr-plate-size">Plate Size:</label>
                            <select id="qr-plate-size" required></select>
                        </div>
                        <div class="form-group">
                            <label for="qr-boxes">Number of Boxes on Pallet:</label>
                            <input type="number" id="qr-boxes" min="1" value="20" required>
                        </div>
                        <div class="form-group">
                            <label for="qr-plates-per-box">Plates per Box:</label>
                            <input type="number" id="qr-plates-per-box" min="1" value="25" required>
                        </div>
                        <div class="form-group">
                            <label>Total Plates on Pallet:</label>
                            <input type="text" id="total-plates-display" readonly style="background: #f8f9fa; font-weight: bold;">
                        </div>
                        <div class="form-group">
                            <label for="pallet-id">Pallet ID:</label>
                            <input type="text" id="pallet-id" placeholder="Will be auto-generated" readonly style="background: #f8f9fa;">
                            <small>Unique pallet tracking ID (auto-generated)</small>
                        </div>
                        <button type="submit" class="btn">üì± Generate Pallet QR Code</button>
                    </form>
                </div>

                <div id="generated-qr" class="qr-grid"></div>

                <div class="data-section">
                    <h3>üì¶ Batch Pallet QR Generation</h3>
                    <p>Generate multiple QR codes for common plate sizes with default pallet configuration:</p>
                    <button class="btn" onclick="generateBatchQRs()">üîÑ Generate Common Sizes (10 Pallets)</button>
                    <button class="btn" onclick="generateAllQRs()">üì± Generate All 39 Sizes</button>
                </div>
            </div>

            <!-- Transactions Page -->
            <div id="transactions" class="page">
                <h2>Transaction Log</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Plate Size</th>
                            <th>Qty</th>
                            <th>Type</th>
                            <th>Source</th>
                            <th>Batch</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // In-memory database simulation
        let plates = [];
        let inboundQueue = [];
        let transactions = [];

        // Initialize with sample data
        function initializeData() {
            // Sample plate sizes with realistic data
            const plateSizes = [
                '50x100', '75x150', '100x200', '50x150', '75x100', '100x150',
                '50x200', '75x200', '100x100', '125x150', '125x200', '150x200',
                '50x250', '75x250', '100x250', '125x250', '150x250', '200x250',
                '50x300', '75x300', '100x300', '125x300', '150x300', '200x300',
                '62x150', '87x200', '112x250', '137x300', '162x350', '187x400',
                '38x125', '63x175', '88x225', '113x275', '138x325', '163x375',
                '44x140', '69x190', '94x240'
            ];

            plates = plateSizes.map((size, index) => ({
                id: index + 1,
                size: size,
                quantity: Math.floor(Math.random() * 400) + 50,
                threshold: Math.floor(Math.random() * 100) + 50
            }));

            // Add some sample pending deliveries
            inboundQueue = [
                {
                    id: 1,
                    plate_size: '75x150',
                    quantity: 500,
                    batch_id: 'PLT123456789',
                    status: 'pending',
                    timestamp: new Date().toISOString(),
                    boxes: 20,
                    plates_per_box: 25
                }
            ];

            updateUI();
        }

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');

            // Update page content if needed
            if (pageId === 'pending') {
                updatePendingList();
            } else if (pageId === 'manual') {
                updateManualForm();
            } else if (pageId === 'admin') {
                updateAdminPage();
            } else if (pageId === 'qr-generator') {
                updateQRGeneratorPage();
            } else if (pageId === 'transactions') {
                updateTransactionsTable();
            }
        }

        function updateUI() {
            updateDashboard();
            updatePendingCount();
        }

        function updateDashboard() {
            const inventoryTable = document.getElementById('inventory-table');
            inventoryTable.innerHTML = '';

            let lowStockCount = 0;

            plates.forEach(plate => {
                const row = document.createElement('tr');
                const isLowStock = plate.quantity <= plate.threshold;
                if (isLowStock) lowStockCount++;

                row.innerHTML = `
                    <td>${plate.size}</td>
                    <td>${plate.quantity}</td>
                    <td>${plate.threshold}</td>
                    <td>
                        <span class="status ${isLowStock ? 'low' : 'ok'}">
                            ${isLowStock ? '‚ö†Ô∏è Low' : '‚úÖ OK'}
                        </span>
                    </td>
                `;
                inventoryTable.appendChild(row);
            });

            // Update stats
            document.getElementById('low-stock').textContent = lowStockCount;
            document.getElementById('pending-deliveries').textContent = inboundQueue.filter(item => item.status === 'pending').length;
        }

        function updatePendingCount() {
            const pendingCount = inboundQueue.filter(item => item.status === 'pending').length;
            document.getElementById('pending-count').textContent = pendingCount;
        }

        function processQRCode() {
            const qrData = document.getElementById('qr-url').value.trim();
            const resultDiv = document.getElementById('qr-result');

            try {
                let plate, totalQty, palletId;

                // Check if it's the new pallet format (pipe-separated)
                if (qrData.includes('|')) {
                    const parts = qrData.split('|');
                    if (parts.length !== 4) {
                        throw new Error('Invalid pallet format. Expected: PlateSize|BoxesOnPallet|PlatesPerBox|PalletID');
                    }

                    plate = parts[0].trim();
                    const boxes = parseInt(parts[1]);
                    const platesPerBox = parseInt(parts[2]);
                    palletId = parts[3].trim();
                    totalQty = boxes * platesPerBox;

                    if (!plate || isNaN(boxes) || isNaN(platesPerBox) || !palletId) {
                        throw new Error('Invalid data in pallet QR code');
                    }

                    // Check if pallet ID already exists
                    if (inboundQueue.some(item => item.batch_id === palletId)) {
                        resultDiv.innerHTML = '<div class="alert error">Error: Pallet ID already exists. Duplicate scan prevented.</div>';
                        return;
                    }

                    // Add to inbound queue
                    const newInbound = {
                        id: inboundQueue.length + 1,
                        plate_size: plate,
                        quantity: totalQty,
                        batch_id: palletId,
                        status: 'pending',
                        timestamp: new Date().toISOString(),
                        boxes: boxes,
                        plates_per_box: platesPerBox
                    };

                    inboundQueue.push(newInbound);

                    resultDiv.innerHTML = `
                        <div class="alert success">
                            <strong>‚úÖ Pallet QR Code Processed Successfully!</strong><br>
                            <strong>Plate Size:</strong> ${plate}<br>
                            <strong>Boxes on Pallet:</strong> ${boxes}<br>
                            <strong>Plates per Box:</strong> ${platesPerBox}<br>
                            <strong>Total Plates:</strong> ${totalQty}<br>
                            <strong>Pallet ID:</strong> ${palletId}<br>
                            <strong>Status:</strong> Pending Approval
                        </div>
                    `;

                } else {
                    // Legacy URL format support
                    const urlObj = new URL(qrData);
                    const params = new URLSearchParams(urlObj.search);
                    
                    plate = params.get('plate');
                    totalQty = parseInt(params.get('qty'));
                    palletId = params.get('batch');

                    if (!plate || !totalQty || !palletId) {
                        throw new Error('Missing required parameters in URL');
                    }

                    // Check if batch already exists
                    if (inboundQueue.some(item => item.batch_id === palletId)) {
                        resultDiv.innerHTML = '<div class="alert error">Error: Batch ID already exists. Duplicate scan prevented.</div>';
                        return;
                    }

                    // Add to inbound queue (legacy format)
                    const newInbound = {
                        id: inboundQueue.length + 1,
                        plate_size: plate,
                        quantity: totalQty,
                        batch_id: palletId,
                        status: 'pending',
                        timestamp: new Date().toISOString()
                    };

                    inboundQueue.push(newInbound);

                    resultDiv.innerHTML = `
                        <div class="alert success">
                            <strong>QR Code Processed Successfully!</strong><br>
                            Plate: ${plate}<br>
                            Quantity: ${totalQty}<br>
                            Batch: ${palletId}<br>
                            Status: Pending Approval
                        </div>
                    `;
                }

                document.getElementById('qr-url').value = '';
                updateUI();

            } catch (error) {
                resultDiv.innerHTML = `<div class="alert error">Error: ${error.message}</div>`;
            }
        }

        function updatePendingList() {
            const pendingList = document.getElementById('pending-list');
            const pendingItems = inboundQueue.filter(item => item.status === 'pending');

            if (pendingItems.length === 0) {
                pendingList.innerHTML = '<p>No pending deliveries.</p>';
                return;
            }

            pendingList.innerHTML = pendingItems.map(item => {
                let detailsHtml = `
                    <strong>Plate Size:</strong> ${item.plate_size}<br>
                    <strong>Total Quantity:</strong> ${item.quantity}<br>
                `;

                // Show pallet details if available
                if (item.boxes && item.plates_per_box) {
                    detailsHtml += `
                        <strong>Boxes on Pallet:</strong> ${item.boxes}<br>
                        <strong>Plates per Box:</strong> ${item.plates_per_box}<br>
                    `;
                }

                detailsHtml += `
                    <strong>Pallet/Batch ID:</strong> ${item.batch_id}<br>
                    <strong>Received:</strong> ${new Date(item.timestamp).toLocaleString()}<br>
                `;

                return `
                    <div class="pending-item">
                        ${detailsHtml}
                        <div class="pending-actions">
                            <button class="btn success" onclick="approveDelivery('${item.batch_id}')">Approve</button>
                            <button class="btn danger" onclick="rejectDelivery('${item.batch_id}')">Reject</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function approveDelivery(batchId) {
            const item = inboundQueue.find(item => item.batch_id === batchId);
            if (!item) return;

            // Update plate stock
            const plate = plates.find(p => p.size === item.plate_size);
            if (plate) {
                plate.quantity += item.quantity;
            }

            // Mark as approved
            item.status = 'approved';

            // Add transaction
            addTransaction({
                plate_size: item.plate_size,
                quantity: item.quantity,
                type: 'in',
                source: 'qr',
                batch_id: batchId
            });

            updateUI();
            updatePendingList();
        }

        function rejectDelivery(batchId) {
            const item = inboundQueue.find(item => item.batch_id === batchId);
            if (!item) return;

            item.status = 'rejected';
            updateUI();
            updatePendingList();
        }

        function updateManualForm() {
            const plateSelect = document.getElementById('manual-plate');
            plateSelect.innerHTML = plates.map(plate => 
                `<option value="${plate.size}">${plate.size}</option>`
            ).join('');
        }

        // Admin Page Functions
        function updateAdminPage() {
            updateEditableInventory();
            updateQRGeneratorPage();
        }

        function updateEditableInventory() {
            const editableInventory = document.getElementById('editable-inventory');
            editableInventory.innerHTML = '';

            plates.forEach(plate => {
                const row = document.createElement('tr');
                const isLowStock = plate.quantity <= plate.threshold;

                row.innerHTML = `
                    <td>${plate.size}</td>
                    <td>
                        <input type="number" value="${plate.quantity}" 
                               onchange="updatePlateData(${plate.id}, 'quantity', this.value)" 
                               min="0">
                    </td>
                    <td>
                        <input type="number" value="${plate.threshold}" 
                               onchange="updatePlateData(${plate.id}, 'threshold', this.value)" 
                               min="0">
                    </td>
                    <td>
                        <span class="status ${isLowStock ? 'low' : 'ok'}">
                            ${isLowStock ? '‚ö†Ô∏è Low' : '‚úÖ OK'}
                        </span>
                    </td>
                `;
                editableInventory.appendChild(row);
            });
        }

        function updatePlateData(plateId, field, value) {
            const plate = plates.find(p => p.id === plateId);
            if (plate) {
                plate[field] = parseInt(value);
                updateDashboard();
                updateEditableInventory();
            }
        }

        function saveInventoryChanges() {
            alert('All inventory changes have been saved!');
            updateDashboard();
        }

        function exportInventory() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "plate_size,quantity,threshold\n" +
                plates.map(plate => `${plate.size},${plate.quantity},${plate.threshold}`).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `inventory_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportTransactions() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "date,plate_size,quantity,type,source,batch_id\n" +
                transactions.map(tx => `${tx.date},${tx.plate_size},${tx.quantity},${tx.type},${tx.source},${tx.batch_id || ''}`).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `transactions_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a CSV file first.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',');
                    
                    // Validate headers
                    if (!headers.includes('plate_size') || !headers.includes('quantity') || !headers.includes('threshold')) {
                        throw new Error('CSV must have columns: plate_size, quantity, threshold');
                    }

                    // Process data
                    let updatedCount = 0;
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        if (values.length >= 3) {
                            const plateSize = values[0].trim();
                            const quantity = parseInt(values[1]);
                            const threshold = parseInt(values[2]);
                            
                            const plate = plates.find(p => p.size === plateSize);
                            if (plate) {
                                plate.quantity = quantity;
                                plate.threshold = threshold;
                                updatedCount++;
                            }
                        }
                    }

                    alert(`Successfully updated ${updatedCount} plate entries!`);
                    updateUI();
                    updateAdminPage();
                    
                } catch (error) {
                    alert(`Error importing CSV: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        function resetSystem() {
            if (confirm('Are you sure you want to reset ALL data? This cannot be undone.')) {
                if (confirm('This will delete all inventory, transactions, and pending deliveries. Continue?')) {
                    initializeData();
                    inboundQueue = [];
                    transactions = [];
                    alert('System has been reset to initial state.');
                    updateUI();
                }
            }
        }

        // QR Generator Functions
        function updateQRGeneratorPage() {
            const plateSelect = document.getElementById('qr-plate-size');
            if (plateSelect) {
                plateSelect.innerHTML = plates.map(plate => 
                    `<option value="${plate.size}">${plate.size}</option>`
                ).join('');
            }
            
            // Add event listeners for calculation
            const boxesInput = document.getElementById('qr-boxes');
            const platesPerBoxInput = document.getElementById('qr-plates-per-box');
            const totalDisplay = document.getElementById('total-plates-display');

            function updateTotalCalculation() {
                const boxes = parseInt(boxesInput.value) || 0;
                const platesPerBox = parseInt(platesPerBoxInput.value) || 0;
                const total = boxes * platesPerBox;
                totalDisplay.value = total > 0 ? `${total} plates` : '';
            }

            if (boxesInput && platesPerBoxInput) {
                boxesInput.addEventListener('input', updateTotalCalculation);
                platesPerBoxInput.addEventListener('input', updateTotalCalculation);
                updateTotalCalculation(); // Initial calculation
            }
        }

        function generatePalletId() {
            const timestamp = Date.now().toString().slice(-6); // Last 6 digits of timestamp
            const random = Math.floor(Math.random() * 900) + 100; // 3-digit random number
            return `PLT${timestamp}${random}`;
        }

        function generateBatchId() {
            // Keep this for legacy compatibility
            const timestamp = Date.now();
            const random = Math.floor(Math.random() * 1000);
            return `BATCH${timestamp}${random}`;
        }

        function generateQRCodeSVG(text) {
            // Simple QR code placeholder - in real implementation, use a QR library
            return `
                <svg width="150" height="150" viewBox="0 0 150 150">
                    <rect width="150" height="150" fill="white" stroke="#000" stroke-width="1"/>
                    <text x="75" y="65" text-anchor="middle" dominant-baseline="middle" font-size="8" fill="#000">
                        PALLET QR
                    </text>
                    <text x="75" y="80" text-anchor="middle" dominant-baseline="middle" font-size="6" fill="#666">
                        ${text.length > 15 ? text.substring(0, 15) + '...' : text}
                    </text>
                    <text x="75" y="95" text-anchor="middle" dominant-baseline="middle" font-size="5" fill="#999">
                        Scan to process
                    </text>
                </svg>
            `;
        }

        function generatePalletQR(plateSize, boxes, platesPerBox, palletId) {
            const totalQty = boxes * platesPerBox;
            const qrData = `${plateSize}|${boxes}|${platesPerBox}|${palletId}`;
            
            return `
                <div class="qr-card">
                    <h4>üè∑Ô∏è Pallet: ${palletId}</h4>
                    <p><strong>Plate Size:</strong> ${plateSize}</p>
                    <p><strong>Boxes:</strong> ${boxes}</p>
                    <p><strong>Plates/Box:</strong> ${platesPerBox}</p>
                    <p><strong>Total Plates:</strong> ${totalQty}</p>
                    <div class="qr-code">
                        ${generateQRCodeSVG(qrData)}
                    </div>
                    <small style="word-break: break-all; font-family: monospace;">${qrData}</small>
                    <br><br>
                    <button class="btn" onclick="downloadPalletQR('${palletId}', '${qrData}')">üì• Download</button>
                    <button class="btn" onclick="printPalletQR('${palletId}')">üñ®Ô∏è Print Label</button>
                </div>
            `;
        }

        function generateBatchQRs() {
            const commonSizes = ['50x100', '75x150', '100x200', '50x150', '75x100', '100x150', '50x200', '75x200', '100x100', '125x150'];
            const generatedDiv = document.getElementById('generated-qr');
            
            let html = '<h3>üì¶ Common Sizes - Pallet QR Codes</h3>';
            
            commonSizes.forEach(size => {
                const palletId = generatePalletId();
                const boxes = 20; // Default boxes
                const platesPerBox = 25; // Default plates per box
                html += generatePalletQR(size, boxes, platesPerBox, palletId);
            });
            
            generatedDiv.innerHTML = html;
        }

        function generateAllQRs() {
            const generatedDiv = document.getElementById('generated-qr');
            
            let html = '<h3>üéØ All Plate Sizes - Pallet QR Codes</h3>';
            
            plates.forEach(plate => {
                const palletId = generatePalletId();
                const boxes = 20; // Default boxes
                const platesPerBox = 25; // Default plates per box
                html += generatePalletQR(plate.size, boxes, platesPerBox, palletId);
            });
            
            generatedDiv.innerHTML = html;
        }

        function downloadPalletQR(palletId, qrData) {
            // Create a detailed text file with the pallet data
            const content = `PALLET QR CODE DATA
============================
Pallet ID: ${palletId}
QR Code Data: ${qrData}

Format: PlateSize|BoxesOnPallet|PlatesPerBox|PalletID

Instructions:
1. Use this data to generate a real QR code with your preferred QR generator
2. Print the QR code and attach to the pallet
3. When scanning, this data will be processed by your storage management system
`;
            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `pallet_${palletId}.txt`;
            link.click();
        }

        function printPalletQR(palletId) {
            alert(`Print pallet label for ${palletId} - In a real implementation, this would send the QR code label to your printer.`);
        }

        function addTransaction(data) {
            transactions.unshift({
                id: transactions.length + 1,
                ...data,
                date: new Date().toISOString()
            });
        }

        function updateTransactionsTable() {
            const transactionsTable = document.getElementById('transactions-table');
            
            if (transactions.length === 0) {
                transactionsTable.innerHTML = '<tr><td colspan="6">No transactions yet.</td></tr>';
                return;
            }

            transactionsTable.innerHTML = transactions.map(tx => `
                <tr>
                    <td>${new Date(tx.date).toLocaleString()}</td>
                    <td>${tx.plate_size}</td>
                    <td>${tx.type === 'in' ? '+' : '-'}${tx.quantity}</td>
                    <td>${tx.type === 'in' ? 'IN' : 'OUT'}</td>
                    <td>${tx.source.toUpperCase()}</td>
                    <td>${tx.batch_id || '-'}</td>
                </tr>
            `).join('');
        }

        // Manual form submission
        document.getElementById('manual-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const plateSize = document.getElementById('manual-plate').value;
            const type = document.getElementById('manual-type').value;
            const qty = parseInt(document.getElementById('manual-qty').value);
            const notes = document.getElementById('manual-notes').value;

            const plate = plates.find(p => p.size === plateSize);
            if (!plate) return;

            if (type === 'out' && plate.quantity < qty) {
                alert('Error: Not enough stock available.');
                return;
            }

            // Update stock
            if (type === 'in') {
                plate.quantity += qty;
            } else {
                plate.quantity -= qty;
            }

            // Add transaction
            addTransaction({
                plate_size: plateSize,
                quantity: qty,
                type: type,
                source: 'manual',
                notes: notes
            });

            // Reset form
            document.getElementById('manual-form').reset();
            
            // Show success message
            alert(`Stock ${type === 'in' ? 'added' : 'removed'} successfully!`);
            
            updateUI();
        });

        // Initialize the application
        initializeData();
    </script>
</body>
</html>